var BOARD_DATA_URL = 'OVERRIDE THIS IN VIEW';
var GAME_SERVER_URL = 'OVERRIDE THIS IN VIEW';
var GAME_ID = 'OVERRIDE THIS IN VIEW';
var USER_ID = 'OVERRIDE THIS IN VIEW';
var USER_AUTH_TOKEN = 'OVERRIDE THIS IN VIEW';
var INITIATIVE_URL = 'OVERRIDE';

var game_board = null;
var game_data = null;

function startGameBoard() {

//  // Disable mobile device scrolling
//  function stopScrolling( touchEvent ) { touchEvent.preventDefault(); }
//  document.addEventListener( 'touchmove' , stopScrolling , false );

  $('body').delegate('#game_container','touchmove',function(e){
    e.preventDefault();
  }).delegate('.scroll','touchmove',function(){
    e.stopPropagation();
  });

  $(document).ready(function () {

    var initiative = InitializeInitiativeApi(INITIATIVE_URL);
    //var toolBars = {}; //InitializeToolBarsApi();
    var camera = InitializeCameraApi();

    var init_window = $("#initiative_window");
    var init_button = $("#open_initiative_button");
    var max_init_height = 500;

//    init_window.dialog({
//      appendTo: "#dialog_container",
//      autoOpen: false,
//      dialogClass: "initiative_dialog",
//      title: "Initiative",
//      width: 225,
//      maxWidth: 360,
//      position: {my: "right top", at: "right-5 top+5", of: "body"},
//      open: function() {
//        var $this = $(this);
//        init_button.hide();
//        var position = $this.dialog( "option", "position" );
//        $this.dialog("option", "position", position);
//      },
//      close: function() {
//        init_button.show();
//      }
//    });

    init_button.click(function() {
      init_window.dialog("open");
    });

    var init_toggle = $("#initiative_toggle");
    var init_display_toggle = $("#initiative_display_toggle");
    var init_view_mode = false;
    var init_panel = $("#initiative_panel");
    var init_controls = $("#initiative_controls");
    var isInitOpen = false;

    init_toggle.click(function() {
      if (isInitOpen) {
        isInitOpen = false;
        init_toggle.html("Open");
        init_controls.hide();
        init_panel.switchClass("open", "closed", 250);
      } else {
        isInitOpen = true;
        init_toggle.html("Close");
        init_controls.show();
        init_panel.switchClass("closed", "open", 250);
      }
    });

    init_display_toggle.click(function() {
      if (init_view_mode) {
        init_view_mode = false;
        initiative.leaveViewMode();
        init_display_toggle.html("View Mode");
      } else {
        init_view_mode = true;
        initiative.enterViewMode();
        init_display_toggle.html("Edit Mode");
      }
    });

    game_board = new Board($("#game_board")[0], initiative, camera);

    $(window).resize(function(e) {
      if (e.target == window) {
        setCanvasSize();

        var position = init_window.dialog( "option", "position" );
        init_window.dialog("option", "position", position);
      }
    });

    setCanvasSize();
    refreshBoard();
  });
}

window.requestAnimFrame = (function () {
  return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
          function (callback) {
            window.setTimeout(callback, 1000 / 60);
          };
})();

function setCanvasSize() {
  // Set game board size
  var width = $("#game_board_container").width();
  var height = $(window).height();
  game_board.setCanvasSize(width, height - 5);
}

function draw_game() {
  game_board.update();

  window.requestAnimFrame(draw_game);
}

function setSize(zoom) {
  game_board.setZoom(parseFloat(zoom));
}

function refreshBoard() {
  $.getJSON(BOARD_DATA_URL, function (data) {
    game_data = data;
    setSize(1.0);
    game_board.refresh(data);
    draw_game();
  });
}